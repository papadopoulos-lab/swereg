% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/tte_enrollment.R
\name{TTEEnrollment}
\alias{TTEEnrollment}
\title{TTEEnrollment class for target trial emulation}
\description{
TTEEnrollment class for target trial emulation

TTEEnrollment class for target trial emulation
}
\details{
Holds the enrollment data, design specification, and workflow state. Methods
modify in-place and return `invisible(self)` for `$`-chaining.
R6 reference semantics mean `trial$data[, := ...]` modifies the data.table
in-place without copy-on-write overhead.


The `data_level` property controls which methods are available:
- `"person_week"`: Data has one row per person per time unit. Pass `ratio`
  to the constructor to enroll and transition to trial level.
- `"trial"`: Data has been expanded to trial panels. Methods `$collapse()`,
  `$ipw()`, `$prepare_for_analysis()`, and `$truncate()` require this level.

Enrollment (matching + panel expansion) transitions data from "person_week"
to "trial" level and is triggered by passing `ratio` to the constructor.
}
\section{Methods}{

**Mutating (return `invisible(self)` for chaining):**
\describe{
  \item{`$collapse(period_width, ...)`}{Collapse time intervals to coarser periods}
  \item{`$ipw(stabilize)`}{Calculate inverse probability of treatment weights}
  \item{`$prepare_for_analysis(outcome, follow_up, ...)`}{Prepare outcome data and calculate IPCW-PP in one step}
  \item{`$truncate(weight_cols, lower, upper, suffix)`}{Truncate extreme weights}
  \item{`$impute_confounders(confounder_vars, seed)`}{Impute missing confounders}
}

**Non-mutating (return data):**
\describe{
  \item{`$extract()`}{Return the data.table}
  \item{`$weight_summary()`}{Print weight distribution diagnostics}
  \item{`$summary(pretty)`}{Return summary statistics}
  \item{`$table1(ipw_col)`}{Generate baseline characteristics table}
  \item{`$rates(weight_col)`}{Calculate events, person-years, and rates}
  \item{`$irr(weight_col)`}{Fit Poisson models and extract IRR}
  \item{`$km(ipw_col, save_path, title)`}{Fit Kaplan-Meier curves}
}

**Active bindings:**
\describe{
  \item{`$enrollment_stage`}{Derived lifecycle stage: `"pre_enrollment"`, `"enrolled"`, or `"analysis_ready"`}
}
}

\examples{
\dontrun{
design <- tte_design(
  person_id_var = "id",
  exposure_var = "exposed",
  outcome_vars = "death",
  confounder_vars = c("age", "sex"),
  follow_up_time = 52L,
  eligible_var = "eligible"
)

# Enroll via constructor, then $-chain
enrollment <- tte_enrollment(my_skeleton, design,
  ratio = 2, seed = 4, extra_cols = "isoyearweek"
)
enrollment$
  collapse(period_width = 4)$
  ipw()$
  prepare_for_analysis(outcome = "death", estimate_ipcw_pp_with_gam = TRUE)
}

}
\seealso{
[tte_enrollment()] for creating trial objects, [TTEDesign] for design class

Other tte_classes: 
\code{\link{TTEDesign}},
\code{\link{TTEPlan}},
\code{\link{tte_design}()},
\code{\link{tte_enrollment}()},
\code{\link{tte_plan}()},
\code{\link{tte_plan_load}()}
}
\concept{tte_classes}
\section{Public fields}{
\if{html}{\out{<div class="r6-fields">}}
\describe{
\item{\code{data}}{A data.table with trial data.}

\item{\code{design}}{A TTEDesign R6 object.}

\item{\code{data_level}}{Character, "person_week" or "trial".}

\item{\code{steps_completed}}{Character vector of completed workflow steps.}

\item{\code{active_outcome}}{Character or NULL, current outcome for IPCW-PP.}

\item{\code{weight_cols}}{Character vector of weight column names.}
}
\if{html}{\out{</div>}}
}
\section{Active bindings}{
\if{html}{\out{<div class="r6-active-bindings">}}
\describe{
\item{\code{enrollment_stage}}{Derived lifecycle stage (read-only).
Returns `"pre_enrollment"` when `data_level == "person_week"`,
`"analysis_ready"` when `prepare_outcome` has been run,
or `"enrolled"` otherwise.}
}
\if{html}{\out{</div>}}
}
\section{Methods}{
\subsection{Public methods}{
\itemize{
\item \href{#method-TTEEnrollment-new}{\code{TTEEnrollment$new()}}
\item \href{#method-TTEEnrollment-print}{\code{TTEEnrollment$print()}}
\item \href{#method-TTEEnrollment-collapse}{\code{TTEEnrollment$collapse()}}
\item \href{#method-TTEEnrollment-ipw}{\code{TTEEnrollment$ipw()}}
\item \href{#method-TTEEnrollment-prepare_for_analysis}{\code{TTEEnrollment$prepare_for_analysis()}}
\item \href{#method-TTEEnrollment-truncate}{\code{TTEEnrollment$truncate()}}
\item \href{#method-TTEEnrollment-impute_confounders}{\code{TTEEnrollment$impute_confounders()}}
\item \href{#method-TTEEnrollment-weight_summary}{\code{TTEEnrollment$weight_summary()}}
\item \href{#method-TTEEnrollment-extract}{\code{TTEEnrollment$extract()}}
\item \href{#method-TTEEnrollment-summary}{\code{TTEEnrollment$summary()}}
\item \href{#method-TTEEnrollment-table1}{\code{TTEEnrollment$table1()}}
\item \href{#method-TTEEnrollment-rates}{\code{TTEEnrollment$rates()}}
\item \href{#method-TTEEnrollment-irr}{\code{TTEEnrollment$irr()}}
\item \href{#method-TTEEnrollment-km}{\code{TTEEnrollment$km()}}
\item \href{#method-TTEEnrollment-clone}{\code{TTEEnrollment$clone()}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-new"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-new}{}}}
\subsection{Method \code{new()}}{
Create a new TTEEnrollment object.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$new(
  data,
  design,
  data_level = "trial",
  steps_completed = character(),
  active_outcome = NULL,
  weight_cols = character(),
  ratio = NULL,
  seed = NULL,
  extra_cols = NULL
)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{data}}{A data.table containing the trial data.}

\item{\code{design}}{A [TTEDesign] object specifying column mappings.}

\item{\code{data_level}}{Character, either "person_week" for pre-panel data or
"trial" for post-panel data. Determines which methods can be applied.}

\item{\code{steps_completed}}{Character vector of completed workflow steps.}

\item{\code{active_outcome}}{Character or NULL, the current outcome for IPCW-PP analysis.}

\item{\code{weight_cols}}{Character vector of weight column names created.}

\item{\code{ratio}}{Numeric or NULL. If provided, automatically enrolls participants
(sampling comparison group and creating trial panels). Only valid for
person_week data.}

\item{\code{seed}}{Integer or NULL. Random seed for enrollment reproducibility.}

\item{\code{extra_cols}}{Character vector or NULL. Extra columns to include in
trial panels during enrollment.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-print"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-print}{}}}
\subsection{Method \code{print()}}{
Print the TTEEnrollment object.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$print(...)}\if{html}{\out{</div>}}
}

}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-collapse"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-collapse}{}}}
\subsection{Method \code{collapse()}}{
Collapse time intervals to coarser periods.
Wraps [tte_collapse_periods()].
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$collapse(
  period_width = 4L,
  time_var = NULL,
  first_cols = NULL,
  last_cols = NULL,
  max_cols = NULL,
  sum_cols = NULL
)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{period_width}}{Integer, default 4.}

\item{\code{time_var}}{Character or NULL; defaults to "trial_week" if present.}

\item{\code{first_cols}}{Character vector of additional first-aggregation columns.}

\item{\code{last_cols}}{Character vector of additional last-aggregation columns.}

\item{\code{max_cols}}{Character vector of additional max-aggregation columns.}

\item{\code{sum_cols}}{Character vector of additional sum-aggregation columns.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-ipw"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-ipw}{}}}
\subsection{Method \code{ipw()}}{
Calculate inverse probability of treatment weights.
Wraps [tte_calculate_ipw()].
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$ipw(stabilize = TRUE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{stabilize}}{Logical, default TRUE.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-prepare_for_analysis"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-prepare_for_analysis}{}}}
\subsection{Method \code{prepare_for_analysis()}}{
Prepare outcome data and calculate IPCW-PP in one step.
Calls `$prepare_outcome()` followed by `$ipcw_pp()`. This is the
recommended way to prepare an enrollment for analysis.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$prepare_for_analysis(
  outcome,
  follow_up = NULL,
  estimate_ipcw_pp_separately_by_exposure = TRUE,
  estimate_ipcw_pp_with_gam = TRUE,
  censoring_var = NULL
)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{outcome}}{Character scalar. Must be one of `design$outcome_vars`.}

\item{\code{follow_up}}{Optional integer. Overrides `design$follow_up_time`.}

\item{\code{estimate_ipcw_pp_separately_by_exposure}}{Logical, default TRUE.}

\item{\code{estimate_ipcw_pp_with_gam}}{Logical, default TRUE.}

\item{\code{censoring_var}}{Character or NULL. Defaults to `"censor_this_period"`.}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-truncate"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-truncate}{}}}
\subsection{Method \code{truncate()}}{
Truncate extreme weights.
Wraps [tte_truncate_weights()].
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$truncate(
  weight_cols = NULL,
  lower = 0.01,
  upper = 0.99,
  suffix = "_trunc"
)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{weight_cols}}{Character vector or NULL.}

\item{\code{lower}}{Numeric, default 0.01.}

\item{\code{upper}}{Numeric, default 0.99.}

\item{\code{suffix}}{Character, default "_trunc".}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-impute_confounders"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-impute_confounders}{}}}
\subsection{Method \code{impute_confounders()}}{
Impute missing confounders by sampling from observed values.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$impute_confounders(confounder_vars, seed = 4L)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{confounder_vars}}{Character vector of confounder column names to impute.}

\item{\code{seed}}{Integer seed for reproducibility (default: 4L).}
}
\if{html}{\out{</div>}}
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-weight_summary"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-weight_summary}{}}}
\subsection{Method \code{weight_summary()}}{
Print weight distribution diagnostics.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$weight_summary()}\if{html}{\out{</div>}}
}

}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-extract"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-extract}{}}}
\subsection{Method \code{extract()}}{
Extract the data.table from the trial object.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$extract()}\if{html}{\out{</div>}}
}

\subsection{Returns}{
A data.table with the processed trial data.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-summary"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-summary}{}}}
\subsection{Method \code{summary()}}{
Summarize trial data statistics.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$summary(pretty = FALSE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{pretty}}{Logical, default FALSE. If TRUE, prints formatted output.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
If `pretty = FALSE`, a list with summary stats. If TRUE, prints
  formatted output and invisibly returns the list.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-table1"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-table1}{}}}
\subsection{Method \code{table1()}}{
Generate baseline characteristics table.
Wraps [tableone::CreateTableOne()] or [tableone::svyCreateTableOne()].
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$table1(ipw_col = NULL)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{ipw_col}}{Character or NULL. If specified, creates weighted table.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
A tableone object.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-rates"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-rates}{}}}
\subsection{Method \code{rates()}}{
Calculate events, person-years, and rates by exposure group.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$rates(weight_col)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{weight_col}}{Character, required. Column name for weights.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
A data.table with events, person-years, and rates.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-irr"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-irr}{}}}
\subsection{Method \code{irr()}}{
Fit Poisson models and extract incidence rate ratios.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$irr(weight_col)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{weight_col}}{Character, required. Column name for weights.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
A data.table with IRR estimates and confidence intervals.
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-km"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-km}{}}}
\subsection{Method \code{km()}}{
Fit Kaplan-Meier curves and optionally plot.
Uses IPW only (not IPCW) because IPCW is time-varying.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$km(ipw_col, save_path = NULL, title = NULL)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{ipw_col}}{Character, required. Column name for IPW weights.}

\item{\code{save_path}}{Character or NULL. If specified, saves the plot.}

\item{\code{title}}{Character or NULL. Plot title.}
}
\if{html}{\out{</div>}}
}
\subsection{Returns}{
A svykm object (invisibly if save_path is specified).
}
}
\if{html}{\out{<hr>}}
\if{html}{\out{<a id="method-TTEEnrollment-clone"></a>}}
\if{latex}{\out{\hypertarget{method-TTEEnrollment-clone}{}}}
\subsection{Method \code{clone()}}{
The objects of this class are cloneable with this method.
\subsection{Usage}{
\if{html}{\out{<div class="r">}}\preformatted{TTEEnrollment$clone(deep = FALSE)}\if{html}{\out{</div>}}
}

\subsection{Arguments}{
\if{html}{\out{<div class="arguments">}}
\describe{
\item{\code{deep}}{Whether to make a deep clone.}
}
\if{html}{\out{</div>}}
}
}
}
